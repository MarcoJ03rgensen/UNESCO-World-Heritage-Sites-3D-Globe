<!DOCTYPE html>
<html lang="en">
<head>
    <title>UNESCO World Heritage Sites 3D Globe</title>
    <meta property="og:description" content="Display a globe with UNESCO World Heritage Sites." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <style>
        body { 
            margin: 0; 
            /* respect device safe areas (notch, rounded corners) */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            background: linear-gradient(45deg, #87CEEB, #4682B4, #5B9BD5);
            background-size: 400% 400%;
            animation: skyShift 10s ease-in-out infinite;
            font-family: 'Inter', sans-serif;
        }
        html, body { height: 100%; }
        /* make map occupy the full viewport and avoid clipping on mobile */
        #map { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 0; }
        @keyframes skyShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        #menu {
            backdrop-filter: blur(15px);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 220px;
            transform: translateX(-110%); /* hide off-screen by default */
            transition: transform 0.28s ease;
            box-sizing: border-box;
        }
        /* When menu has .open, slide it into view */
        #menu.open { transform: translateX(0%); }
        #menu h4 { color: white; }
        #menu label { color: white; }
        #toggle-menu {
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.18);
            transition: all 0.18s;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            z-index: 1001;
            cursor: pointer;
        }
        /* allow left to be controlled by stylesheet and animate movement */
        #toggle-menu { left: 10px; transition: left 0.28s ease, transform 0.18s; }
        /* when the menu is open, move the toggle to the right edge of the menu so it doesn't cover content */
        #menu.open + #toggle-menu {
            left: calc(10px + 220px + 8px) !important; /* menu left + menu width + small gap */
        }
        #toggle-menu:hover { transform: translateY(-2px); }
        #apply {
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        #apply:hover {
            background: rgba(255,255,255,0.2) !important;
            transform: scale(1.05);
        }
        #citation {
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        #citation a { color: #87CEEB; }
        .maplibregl-popup-content {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            /* add top padding so the close button doesn't overlap header text */
            padding: 20px 15px 15px 15px;
            max-width: 320px;
            /* allow long descriptions to scroll inside the popup */
            max-height: 45vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Ensure popup titles don't overlap the close button: reserve space to the right */
        .maplibregl-popup-content h3 {
            margin: 0 0 10px 0 !important;
            /* reserve ~64px for the close button and breathing room */
            max-width: calc(100% - 64px) !important;
            display: block !important;
            word-break: break-word !important;
            overflow-wrap: anywhere !important;
            white-space: normal !important;
        }

        /* Larger, clearer close button for popups */
        .maplibregl-popup-close-button {
            width: 38px !important;
            height: 38px !important;
            line-height: 38px !important;
            font-size: 20px !important;
            border-radius: 8px !important;
            top: 8px !important;
            right: 8px !important;
            background: rgba(255,255,255,0.06) !important;
            color: white !important;
            text-align: center !important;
            padding: 0 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        }
          /* Ensure the close button text is visible and centered (we set the glyph in JS) */
          .maplibregl-popup-close-button { text-indent: 0 !important; }
        .maplibregl-ctrl-group {
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            border-radius: 5px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
            /* Make control group match logo width and center buttons */
            width: 44px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            padding: 4px !important;
        }
        .maplibregl-ctrl-group button {
            background: transparent !important;
            color: white !important;
            border: none !important;
            width: 36px !important;
            height: 36px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            margin: 4px 0 !important;
            font-size: 18px !important;
        }
        .maplibregl-ctrl-group button:hover {
            background: rgba(255,255,255,0.12) !important;
        }
        /* Ensure bottom-right MapLibre attribution / logo stays visible on small screens */
        .maplibregl-ctrl-bottom-right {
            right: 10px !important;
            bottom: 10px !important;
            z-index: 1002 !important;
        }
        .maplibregl-ctrl-bottom-right .maplibregl-ctrl {
            width: auto !important;
        }

        /* Make citation more prominent and visible on phones */
        #citation {
            z-index: 1003 !important;
            padding: 8px 10px !important;
            font-size: 11px !important;
            right: auto !important;
            left: 10px !important;
            bottom: 10px !important;
        }

        /* Responsive tweaks: keep both visible on narrow viewports */
        @media (max-width: 600px) {
            #citation { left: 8px !important; bottom: 8px !important; font-size: 11px; }
            .maplibregl-ctrl-bottom-right { right: 8px !important; bottom: 8px !important; }
            /* make sure menu toggle doesn't overlap citation on very small screens */
            #toggle-menu { top: 12px !important; left: 12px !important; }
        }

        /* Citation toggle for small screens: hide full citation, show compact toggle */
        #citation-toggle { display: none; }
        @media (max-width: 600px) {
            /* hide citation by default on phones; will be shown when .visible */
            #citation { display: none !important; }
            #citation.visible { display: block !important; position: fixed !important; left: 10px !important; bottom: 60px !important; width: calc(100% - 40px) !important; max-width: 320px !important; border-radius: 10px !important; }

            /* small toggle button at bottom-left */
            #citation-toggle {
                display: flex !important;
                position: fixed !important;
                left: 10px !important;
                bottom: 10px !important;
                width: 44px !important;
                height: 44px !important;
                border-radius: 8px !important;
                align-items: center !important;
                justify-content: center !important;
                background: rgba(255,255,255,0.08) !important;
                border: 1px solid rgba(255,255,255,0.12) !important;
                z-index: 1004 !important;
                box-shadow: 0 6px 18px rgba(0,0,0,0.18) !important;
                cursor: pointer !important;
            }
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="menu" style="position: absolute; top: 10px; left: 10px; padding: 15px; border-radius: 10px; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <h4 style="margin-top: 0; font-weight: 600;">Filter Sites</h4>
    <strong>Type:</strong><br>
    <label><input type="checkbox" id="cultural" checked> Cultural</label><br>
    <label><input type="checkbox" id="natural" checked> Natural</label><br>
    <label><input type="checkbox" id="mixed" checked> Mixed</label><br>
    <strong>Status:</strong><br>
    <label><input type="checkbox" id="in-danger" checked> In Danger</label><br>
    <button id="apply" style="margin-top: 15px; padding: 8px 15px; background: linear-gradient(45deg, #06768d, #055a6a); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Apply</button>
</div>
<button id="toggle-menu" style="position: absolute; top: 10px; z-index: 1001; font-size: 20px;" aria-expanded="false">‚ò∞</button>
<div id="citation" style="position: absolute; bottom: 10px; left: 10px; padding: 5px; border-radius: 5px; z-index: 1000; box-shadow: 0 4px 16px rgba(0,0,0,0.2); font-size: 10px;">
    <strong style="color: white;">Citation:</strong> <span style="color: rgba(255,255,255,0.9);">Chlo√© Meyer (2024). World Heritage Site List [Data set]. UNESCO IHP-WINS. <a href="https://doi.org/10.63253/qblhcalw" target="_blank" style="color: #87CEEB;">https://doi.org/10.63253/qblhcalw</a></span>
</div>
<!-- Citation toggle for phones -->
<button id="citation-toggle" aria-controls="citation" aria-expanded="false" title="Show citation" style="display:none;">‚ÑπÔ∏è</button>
<!-- Unavngivet logo placed next to MapLibre controls (top-right). Matches control size and glass style -->
/* swap positions: custom logo will sit where controls usually sit, controls will sit directly beneath the logo */
<style>
    /* Container position: put the map controls directly under the logo (same right offset) */
    .maplibregl-ctrl-top-right {
        right: 10px !important;
        /* push controls down so they don't touch the logo */
        top: 64px !important;
        width: 44px !important;
        padding: 0 !important;
        box-sizing: border-box !important;
        display: block !important;
    }
    /* Ensure the inner control wrapper fills that container and centers its child group */
    .maplibregl-ctrl-top-right .maplibregl-ctrl {
        width: 100% !important;
        display: flex !important;
        justify-content: center !important;
        padding: 0 !important;
        box-sizing: border-box !important;
    }
    .maplibregl-ctrl-top-right .maplibregl-ctrl-group {
        margin: 0 auto !important;
        width: 100% !important;
        box-sizing: border-box !important;
        padding: 0 !important;
    }
    /* Place the custom logo where the controls usually are */
    #custom-logo { right: 10px !important; top: 8px !important; }
</style>

<a href="https://marcoj03rgensen.github.io/" target="_blank" id="custom-logo" aria-label="Unavngivet" style="position: absolute; top: 8px; right: 10px; width: 44px; height: 44px; text-decoration: none; z-index: 1001; display:flex; align-items:center; justify-content:center;">
    <img src="marco-j√∏rgensen.png" alt="Unavngivet" style="width: 100%; height: 100%; border-radius: 50%; object-fit:cover; box-shadow: 0 4px 12px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.18);">
</a>
<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://demotiles.maplibre.org/style.json',
        zoom: 2,
        center: [0, 0],
        attributionControl: true
    });

    map.on('style.load', () => {
        map.setProjection({
            type: 'globe', // Set projection to globe
        });

        // Add navigation control for zoom/pan on mobile
        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        // Enhance globe surface colors for clarity
        if (map.getLayer('background')) {
            map.setPaintProperty('background', 'background-color', '#06768d');
        }
        if (map.getLayer('land')) {
            map.setPaintProperty('land', 'fill-color', '#228B22');
        }
        if (map.getLayer('water')) {
            map.setPaintProperty('water', 'fill-color', '#06768d');
        }
        if (map.getLayer('ocean')) {
            map.setPaintProperty('ocean', 'fill-color', '#06768d');
        }
        if (map.getLayer('country-boundaries')) {
            map.setPaintProperty('country-boundaries', 'line-color', '#000000');
            map.setPaintProperty('country-boundaries', 'line-opacity', 1);
            map.setPaintProperty('country-boundaries', 'line-width', 3);
        }
        if (map.getLayer('admin-1-boundaries')) {
            map.setPaintProperty('admin-1-boundaries', 'line-color', '#333333');
            map.setPaintProperty('admin-1-boundaries', 'line-opacity', 0.8);
            map.setPaintProperty('admin-1-boundaries', 'line-width', 1);
        }

        // Load CSV data
        fetch('https://ihp-wins.unesco.org/dataset/unesco-world-heritage-sites/resource/2f46f6b2-45f9-402b-ace9-1e02c9c97a3d/download/whc-sites-2025.csv')
            .then(response => response.text())
            .then(data => {
                const parsed = Papa.parse(data, { header: true, skipEmptyLines: true });
                const sites = [];

                parsed.data.forEach((site, index) => {
                    if (site.latitude && site.longitude && !isNaN(parseFloat(site.latitude)) && !isNaN(parseFloat(site.longitude))) {
                        sites.push({
                            type: 'Feature',
                            properties: {
                                id: index,
                                name: site.name_en,
                                category: site.category_short,
                                danger: site.danger,
                                country: site.states_name_en,
                                description: site.short_description_en
                            },
                            geometry: {
                                type: 'Point',
                                coordinates: [parseFloat(site.longitude), parseFloat(site.latitude)]
                            }
                        });
                    }
                });

                // Add source
                map.addSource('sites', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: sites
                    }
                });

                // Add layer for sites
                map.addLayer({
                    id: 'sites-layer',
                    type: 'circle',
                    source: 'sites',
                    paint: {
                        'circle-radius': 5,
                        'circle-color': [
                            'match',
                            ['get', 'category'],
                            'C', '#ff7f0e', // Cultural - orange
                            'N', '#1f77b4', // Natural - blue
                            'M', '#2ca02c', // Mixed - green
                            '#9467bd' // Default - purple
                        ],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#000000',
                        'circle-opacity': 0.9,
                        'circle-stroke-opacity': 0.8,
                        'circle-blur': 0.2
                    }
                });

                // Add hover layer for enlarged marker
                map.addLayer({
                    id: 'sites-hover-layer',
                    type: 'circle',
                    source: 'sites',
                    paint: {
                        'circle-radius': 12,
                        'circle-color': [
                            'match',
                            ['get', 'category'],
                            'C', '#ff7f0e', // Cultural - orange
                            'N', '#1f77b4', // Natural - blue
                            'M', '#2ca02c', // Mixed - green
                            '#9467bd' // Default - purple
                        ],
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#000000',
                        'circle-opacity': 1,
                        'circle-stroke-opacity': 1,
                        'circle-blur': 0
                    },
                    filter: ['==', 'id', -1] // Initially no features
                });

                // Add popup: zoom to feature and show a scrollable popup for long descriptions
                map.on('click', 'sites-layer', (e) => {
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const properties = e.features[0].properties;
                    const categoryIcon = properties.category === 'C' ? 'üèõÔ∏è' : properties.category === 'N' ? 'üåø' : 'üèûÔ∏è';

                    // compute a sensible zoom target (don't over-zoom)
                    const currentZoom = map.getZoom();
                    const targetZoom = Math.min(8, Math.max(currentZoom + 1.5, 5));

                    // center with a slight upward offset so the popup (which appears above the point)
                    // has room to display without being clipped on mobile
                    map.easeTo({ center: coordinates, zoom: targetZoom, offset: [0, -80], duration: 700 });

                    const popupHtml = `
                        <div style="text-align: left;">
                            <h3 style="margin: 0 0 10px 0; color: #87CEEB;">${properties.name}</h3>
                            <p style="margin: 5px 0;"><strong>${categoryIcon} Category:</strong> ${properties.category === 'C' ? 'Cultural' : properties.category === 'N' ? 'Natural' : 'Mixed'}</p>
                            <p style="margin: 5px 0;"><strong>üåç Country:</strong> ${properties.country}</p>
                            <div style="margin: 10px 0; font-size: 14px; line-height: 1.4;">${properties.description}</div>
                        </div>
                    `;

                    // create popup with explicit options and add to map
                    const popup = new maplibregl.Popup({ maxWidth: '320px', closeButton: true, closeOnClick: false })
                        .setLngLat(coordinates)
                        .setHTML(popupHtml)
                        .addTo(map);

                    // Ensure the close button shows a single big √ó and is centered
                    try {
                        const btn = popup._container && popup._container.querySelector && popup._container.querySelector('.maplibregl-popup-close-button');
                        if (btn) {
                            btn.textContent = '√ó';
                            btn.setAttribute('aria-label', 'Close');
                            btn.style.width = '38px';
                            btn.style.height = '38px';
                            btn.style.lineHeight = '38px';
                            btn.style.fontSize = '20px';
                            btn.style.display = 'inline-flex';
                            btn.style.alignItems = 'center';
                            btn.style.justifyContent = 'center';
                            btn.style.textIndent = '0';
                        }
                    } catch (err) {
                        // ignore if popup internals change
                    }
                });

                // Add fade-in animation for markers
                map.setPaintProperty('sites-layer', 'circle-opacity', 0);
                let opacity = 0;
                const fadeIn = setInterval(() => {
                    opacity += 0.05;
                    if (opacity >= 0.9) {
                        opacity = 0.9;
                        clearInterval(fadeIn);
                    }
                    map.setPaintProperty('sites-layer', 'circle-opacity', opacity);
                }, 50);

                // Change cursor on hover
                map.on('mouseenter', 'sites-layer', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    const id = e.features[0].properties.id;
                    map.setFilter('sites-hover-layer', ['==', ['get', 'id'], id]);
                });
                map.on('mouseleave', 'sites-layer', () => {
                    map.getCanvas().style.cursor = '';
                    map.setFilter('sites-hover-layer', ['==', ['get', 'id'], -1]);
                });

                // Menu toggle (use class to avoid inline-style mismatches)
                document.getElementById('toggle-menu').addEventListener('click', () => {
                    const menu = document.getElementById('menu');
                    const isOpen = menu.classList.toggle('open');
                    // Accessibility
                    document.getElementById('toggle-menu').setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                });

                // Citation toggle for small screens
                const citationEl = document.getElementById('citation');
                const citationToggle = document.getElementById('citation-toggle');
                if (citationToggle && citationEl) {
                    citationToggle.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        const visible = citationEl.classList.toggle('visible');
                        citationToggle.setAttribute('aria-expanded', visible ? 'true' : 'false');
                    });

                    // prevent clicks inside citation from closing it
                    citationEl.addEventListener('click', (ev) => ev.stopPropagation());

                    // click outside hides citation on small screens
                    document.addEventListener('click', () => {
                        if (window.innerWidth <= 600 && citationEl.classList.contains('visible')) {
                            citationEl.classList.remove('visible');
                            citationToggle.setAttribute('aria-expanded', 'false');
                        }
                    });

                    // hide citation when resizing to larger screens
                    window.addEventListener('resize', () => {
                        if (window.innerWidth > 600) {
                            citationEl.classList.remove('visible');
                            citationToggle.setAttribute('aria-expanded', 'false');
                        }
                    });
                }

                // Ensure the map resizes on orientation/viewport changes so the globe isn't clipped
                function safeResize() {
                    try { if (map && typeof map.resize === 'function') map.resize(); } catch (e) { /* ignore */ }
                }
                window.addEventListener('resize', () => { setTimeout(safeResize, 60); });
                window.addEventListener('orientationchange', () => { setTimeout(safeResize, 180); });
                // trigger an initial resize after elements settle
                setTimeout(safeResize, 300);

                // Apply filter
                document.getElementById('apply').addEventListener('click', () => {
                    const selectedTypes = [];
                    if (document.getElementById('cultural').checked) selectedTypes.push('C');
                    if (document.getElementById('natural').checked) selectedTypes.push('N');
                    if (document.getElementById('mixed').checked) selectedTypes.push('M');

                    const filters = [];
                    if (selectedTypes.length > 0) filters.push(['in', 'category', ...selectedTypes]);

                    const inDanger = document.getElementById('in-danger').checked;
                    if (inDanger) {
                        filters.push(['==', 'danger', '1']);
                    }

                    const filter = filters.length > 1 ? ['all', ...filters] : (filters.length === 1 ? filters[0] : ['==', 'category', '']);
                    map.setFilter('sites-layer', filter);
                    map.setFilter('sites-hover-layer', ['==', 'id', -1]); // Reset hover
                });
            });
    });
</script>
</body>
</html>